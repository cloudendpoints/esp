#!/bin/bash
#
# Copyright (C) Extensible Service Proxy Authors
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#
################################################################################
#

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
. ${ROOT}/script/all-utilities || { echo "Cannot load Bash utilities"; exit 1; }


##################################################
# Step 1: Install Bazel
##################################################

# Download (update the URL when upgrading Bazel)
BAZEL_INSTALLER_URL='https://github.com/bazelbuild/bazel/releases/download/0.21.0/bazel-0.21.0-installer-linux-x86_64.sh'
curl -L "${BAZEL_INSTALLER_URL}" -o ./bazel-installer.sh || \
  error_exit "Failed to get the bazel installer from ${BAZEL_INSTALLER_URL}"
chmod +x ./bazel-installer.sh

# Install
./bazel-installer.sh --user || \
  error_exit "Failed to install bazel using an installer from ${BAZEL_INSTALLER_URL}"


##################################################
# Step 2: Install Google Cloud SDK (gcloud)
##################################################

# Skip the steps 2 & 3 for Pull Requests.
# There is no way to securely authenticate a service account with gcloud for
# Pull Requests.
if [[ "${TRAVIS_PULL_REQUEST}" != "false" ]]; then
  echo "Skipping gcloud installation as this is a Pull Request"
  exit 0
fi

# First, remove the old version on the VM installed via package manager
sudo apt-get update
sudo apt-get -qqy remove google-cloud-sdk

# Download
GCLOUD_INSTALLER_URL="https://sdk.cloud.google.com"
curl -L "${GCLOUD_INSTALLER_URL}" -o ./gcloud-installer.sh || \
  error_exit "Failed to get the gcloud installer from ${GCLOUD_INSTALLER_URL}"
chmod +x ./gcloud-installer.sh

# Install
CLOUDSDK_INSTALL_DIR="${HOME}" CLOUDSDK_CORE_DISABLE_PROMPTS=1 \
  ./gcloud-installer.sh || \
  error_exit "Failed to install gcloud using an installer from ${GCLOUD_INSTALLER_URL}"


##################################################
# Step 3: Activate the service account in gcloud
##################################################

# This command is generated by Travis CLI. To update the service account secret:
#   1) install Travis CLI by following instructions in
#      https://github.com/travis-ci/travis.rb#installation.
#   2) travis login [--github-token <token>] [--pro | --org]
#   3) cd <root_of_the_repo>
#   4) cp -f <path_to_the_new_secret> script/travis/service-account-secret.json
#   5) travis encrypt-file \
#        script/travis/service-account-secret.json \
#        script/travis/service-account-secret.json.enc \
#        --repo <org>/<repo>
#   6) copy & paste the new command here.
openssl aes-256-cbc \
  -K $encrypted_b827e9b0c12c_key \
  -iv $encrypted_b827e9b0c12c_iv \
  -in script/travis/service-account-secret.json.enc \
  -out script/travis/service-account-secret.json -d || \
  echo "WARNING: Failed to decrypt the service account secret"

# Activate the service account using gcloud
GCLOUD="${HOME}/google-cloud-sdk/bin/gcloud"
"${GCLOUD}" auth activate-service-account \
  --key-file script/travis/service-account-secret.json || \
  echo "WARNING: Failed to authenticate the service account."
